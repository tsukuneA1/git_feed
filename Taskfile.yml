version: '3'

vars:
  BACKEND_DIR: ./backend
  FRONTEND_DIR: ./frontend

tasks:
  # ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¿ã‚¹ã‚¯
  install:
    desc: "ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆbackend + frontendï¼‰"
    deps: [backend:install, frontend:install]

  # é–‹ç™ºã‚µãƒ¼ãƒãƒ¼èµ·å‹•
  dev:
    desc: "é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ï¼ˆbackend + frontendï¼‰"
    cmds:
      - task kill-ports
      - echo "ğŸš€ Starting development servers..."
      - echo ""
      - task --parallel backend:dev frontend:dev

  kill-ports:
    desc: "é–‹ç™ºãƒãƒ¼ãƒˆã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—"
    cmds:
      - lsof -ti:3000,3001 | xargs -r kill -9 || true
      - pkill -f "rails server|next dev" || true

  # ãƒ“ãƒ«ãƒ‰
  build:
    desc: "å…¨ä½“ã‚’ãƒ“ãƒ«ãƒ‰"
    deps: [backend:build, frontend:build]

  # ãƒ†ã‚¹ãƒˆ
  test:
    desc: "ãƒ†ã‚¹ãƒˆã¯è¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“"
    cmds:
      - echo "ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ»ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã¨ã‚‚ã«ãƒ†ã‚¹ãƒˆãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“"

  # ãƒªãƒ³ãƒˆ
  lint:
    desc: "å…¨ä½“ã®ãƒªãƒ³ãƒˆã‚’å®Ÿè¡Œ"
    deps: [backend:lint, frontend:lint]

  # ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
  clean:
    desc: "ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—"
    deps: [backend:clean, frontend:clean]

  # Backend Tasks
  backend:install:
    desc: "Railsã®ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«"
    dir: "{{.BACKEND_DIR}}"
    cmds:
      - bundle install

  backend:dev:
    desc: "Railsé–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•"
    dir: "{{.BACKEND_DIR}}"
    cmds:
      - bundle exec rails server -p 3000 2>&1 | sed 's/^/[BACKEND]  | /'

  backend:build:
    desc: "Railsã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒ“ãƒ«ãƒ‰"
    dir: "{{.BACKEND_DIR}}"
    cmds:
      - bundle exec rails assets:precompile

  backend:test:
    desc: "ãƒ†ã‚¹ãƒˆã¯è¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“"
    dir: "{{.BACKEND_DIR}}"
    cmds:
      - echo "ãƒ†ã‚¹ãƒˆãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“"

  backend:lint:
    desc: "Railsã®ã‚³ãƒ¼ãƒ‰ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ãƒã‚§ãƒƒã‚¯"
    dir: "{{.BACKEND_DIR}}"
    cmds:
      - bundle exec rubocop

  backend:clean:
    desc: "Railsã®ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—"
    dir: "{{.BACKEND_DIR}}"
    cmds:
      - rm -rf tmp/cache/*
      - rm -rf log/*.log
      - rm -rf public/assets

  backend:db:create:
    desc: "ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ä½œæˆ"
    dir: "{{.BACKEND_DIR}}"
    cmds:
      - bundle exec rails db:create

  backend:db:migrate:
    desc: "ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œ"
    dir: "{{.BACKEND_DIR}}"
    cmds:
      - bundle exec rails db:migrate

  backend:db:seed:
    desc: "ã‚·ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚’æŠ•å…¥"
    dir: "{{.BACKEND_DIR}}"
    cmds:
      - bundle exec rails db:seed

  backend:db:reset:
    desc: "ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆ"
    dir: "{{.BACKEND_DIR}}"
    cmds:
      - bundle exec rails db:drop db:create db:migrate db:seed

  # Frontend Tasks
  frontend:install:
    desc: "Next.jsã®ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«"
    dir: "{{.FRONTEND_DIR}}"
    cmds:
      - pnpm install

  frontend:dev:
    desc: "Next.jsé–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•"
    dir: "{{.FRONTEND_DIR}}"
    cmds:
      - pnpm dev 2>&1 | sed 's/^/[FRONTEND] | /'

  frontend:build:
    desc: "Next.jsã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒ“ãƒ«ãƒ‰"
    dir: "{{.FRONTEND_DIR}}"
    cmds:
      - pnpm build

  frontend:start:
    desc: "Next.jsæœ¬ç•ªã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•"
    dir: "{{.FRONTEND_DIR}}"
    cmds:
      - pnpm start

  frontend:test:
    desc: "ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ"
    dir: "{{.FRONTEND_DIR}}"
    cmds:
      - echo "ãƒ†ã‚¹ãƒˆãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“"

  frontend:lint:
    desc: "ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ãƒªãƒ³ãƒˆã‚’å®Ÿè¡Œï¼ˆBiome + ESLintï¼‰"
    dir: "{{.FRONTEND_DIR}}"
    cmds:
      - pnpm lint

  frontend:clean:
    desc: "ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—"
    dir: "{{.FRONTEND_DIR}}"
    cmds:
      - rm -rf .next
      - rm -rf out
      - rm -rf node_modules/.cache

  # Dockeré–¢é€£ã‚¿ã‚¹ã‚¯
  docker:build:
    desc: "Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰"
    cmds:
      - docker-compose build

  docker:up:
    desc: "Dockerã‚³ãƒ³ãƒ†ãƒŠã‚’èµ·å‹•"
    cmds:
      - docker-compose up -d

  docker:down:
    desc: "Dockerã‚³ãƒ³ãƒ†ãƒŠã‚’åœæ­¢"
    cmds:
      - docker-compose down

  docker:logs:
    desc: "Dockerã‚³ãƒ³ãƒ†ãƒŠã®ãƒ­ã‚°ã‚’è¡¨ç¤º"
    cmds:
      - docker-compose logs -f

  # CI/CDã‚¿ã‚¹ã‚¯
  ci:frontend:
    desc: "ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®CI/CDãƒã‚§ãƒƒã‚¯ï¼ˆBiome + ESLint + TypeScriptï¼‰"
    dir: "{{.FRONTEND_DIR}}"
    cmds:
      - pnpm biome check .
      - pnpm next lint
      - pnpm tsc --noEmit

  ci:backend:
    desc: "ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®CI/CDãƒã‚§ãƒƒã‚¯ï¼ˆRuboCopï¼‰"
    dir: "{{.BACKEND_DIR}}"
    cmds:
      - bundle exec rubocop

  ci:all:
    desc: "å…¨ä½“ã®CI/CDãƒã‚§ãƒƒã‚¯"
    deps: [ci:frontend, ci:backend]

  # ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã‚¿ã‚¹ã‚¯
  format:
    desc: "ã‚³ãƒ¼ãƒ‰å…¨ä½“ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ"
    deps: [backend:format, frontend:format]

  backend:format:
    desc: "ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚³ãƒ¼ãƒ‰ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ"
    dir: "{{.BACKEND_DIR}}"
    cmds:
      - bundle exec rubocop -a

  frontend:format:
    desc: "ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚³ãƒ¼ãƒ‰ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆBiome + ESLintï¼‰"
    dir: "{{.FRONTEND_DIR}}"
    cmds:
      - pnpm lint:fix