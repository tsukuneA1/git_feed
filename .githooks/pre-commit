#!/bin/bash

# Pre-commit hook for CI checks
set -e

echo "üîç Running pre-commit CI checks..."

# Get list of changed files
CHANGED_FILES=$(git diff --cached --name-only)

# Check if frontend files changed
if echo "$CHANGED_FILES" | grep -q "^frontend/"; then
    echo "üì± Frontend files changed, running frontend checks..."
    
    echo "  ‚Ü≥ Running Biome check..."
    cd frontend && pnpm biome check . || exit 1
    
    echo "  ‚Ü≥ Running ESLint check..."
    pnpm next lint || exit 1
    
    echo "  ‚Ü≥ Running TypeScript check..."
    pnpm tsc --noEmit || exit 1
    
    cd ..
    echo "‚úÖ Frontend checks passed!"
fi

# Check if backend files changed
if echo "$CHANGED_FILES" | grep -q "^backend/"; then
    echo "‚ö° Backend files changed, running backend checks..."
    
    echo "  ‚Ü≥ Running RuboCop check..."
    cd backend && bundle exec rubocop || exit 1
    
    cd ..
    echo "‚úÖ Backend checks passed!"
fi

# Check for .env files
if echo "$CHANGED_FILES" | grep -E "\\.env$|\\.env\\..*"; then
    echo "‚ùå Error: .env files should not be committed!"
    echo "Please remove .env files from your commit:"
    echo "$CHANGED_FILES" | grep -E "\\.env$|\\.env\\..*"
    exit 1
fi

echo "üéâ All pre-commit checks passed!"